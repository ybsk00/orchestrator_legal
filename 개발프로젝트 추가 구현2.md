# 개발 프로젝트 오케스트레이터 구현 계획안 (v2.1 패치 — v2.0 보완사항 반영)
목표: v2.0 설계를 유지하면서 **사용자 개입(매 턴 Steering) 품질**, **반복 방지 안정성**, **운영/재연결 내구성**을 강화한다.  
적용 대상: AntiGravity 작업 지시용(코드 생성/리팩토링 기준 문서)

---

## 1) 핵심 보완 요약 (v2.1)
1. **ROUND_END 페이로드를 표준 스키마로 고정**하여 USER_GATE에서 사용자가 “무엇을 입력해야 하는지” 명확히 한다.
2. Steering Guard의 `pending` 처리 UX/정책을 명확히 하여 **무한 보류/혼란**을 방지한다.
3. 에이전트 **출력 스키마를 R2/R3까지 라운드 목적에 맞게 구체화**하여 반복을 구조적으로 차단한다.
4. Rewrite(중복 70%)의 **비교 기준을 ‘항목 단위 리스트’ 중심으로 고정**해 구현 변동성을 줄인다.
5. CaseFile에 **결정/범위/리스크/스티어링 히스토리**를 분리 저장하여 “이전 대화 기반 지속”을 안정화한다.
6. /report 최종 결과물은 **JSON 스키마 고정**으로 렌더링/재사용을 안정화한다.

---

## 2) ROUND_END 표준 페이로드 (필수) — USER_GATE 품질 핵심
### 2.1 서버 이벤트: `ROUND_END`
각 라운드 종료 시 SSE로 `ROUND_END` 이벤트를 발송한다. (R1/R2는 USER_GATE 진입 전, R3는 END_GATE 진입 전)

**ROUND_END_PAYLOAD (고정 스키마)**
- `session_id: str`
- `project_type: "dev_project"`
- `current_round: int`
- `phase_completed: str`
- `what_changed: string[]` (최대 3)
- `decisions_so_far: string[]` (최대 3)
- `open_issues: string[]` (최대 5)
- `risks_top: string[]` (최대 3)
- `recommended_focus_options: { prd: string, ux: string, tech: string }` (각 1개)
- `steering_needed: bool`
- `steering_questions: string[]` (최대 2)
- `timestamp: str(ISO)`

> 목적: USER_GATE에서 사용자가 “선택/결정”을 할 수 있는 근거를 제공한다.

---

## 3) Steering Guard v2.1 — pending 처리 정책(필수)
### 3.1 Steering 상태
- `committed`: 다음 라운드 프롬프트 최상단에 강제 주입
- `pending`: 모순/불명확/과도한 변경 요청 → 사용자 확인 필요
- `rejected`: 금지 규칙 위반 → 반영 불가

### 3.2 pending UX 정책 (프론트/백 공통)
pending 발생 시 USER_GATE에서 아래 선택지를 제공한다:
- `Fix now`: 서버가 생성한 확인 질문(최대 2개)에 답하도록 UI 노출 → 답변으로 정규화 재시도
- `Proceed with defaults`: pending 항목은 반영하지 않고 “기본값 + 기존 committed steering”으로 진행

### 3.3 pending 연속 제한(운영 안정성)
- `pending`은 **연속 1회만 허용**
- 같은 라운드/연속 라운드에서 pending이 2회 연속이면 자동으로 `Proceed with defaults` 처리하여 진행
- pending/rejected 항목은 `open_issues`에 기록하되 **프롬프트 최상단 주입 금지**

---

## 4) 출력 스키마 강화 (R1/R2/R3 라운드별 고정) — 반복 방지 핵심
> v2.0의 스키마를 유지하되, R2/R3 목적을 “필드”로 고정한다.  
> 모든 에이전트 답변 마지막 줄에 `Steering Compliance Check: OK|NOT_OK` 필수.

### 4.1 PRD Owner
#### R1 (Define)
- `Problem`
- `TargetUsers`
- `SuccessMetrics` (<=3)
- `InScope` / `OutOfScope`
- `UserScenarios` (<=2)
- `OpenQuestions` (<=3)

#### R2 (Scope Adjust)
- `ScopeChanges`:
  - `Add: string[]` (<=3)
  - `Remove: string[]` (<=3)
- `PriorityReorder` (<=5 lines)
- `ClarificationsNeeded` (<=2)
- `OpenQuestions` (<=3)

#### R3 (Lock PRD)
- `FinalRequirements` (<=7 bullets)
- `AcceptanceCriteria` (<=5)
- `NonGoals` (<=5)
- `KnownUnknowns` (<=3)

### 4.2 UX Lead (디자인 필수 산출물 강제)
#### R1 (UX Define)
- `PrimaryUserFlow` (3~6 steps)
- `KeyScreens` (정확히 3개):
  - ScreenName / Purpose / MainComponents / PrimaryCTA / Empty&ErrorState
- `InteractionRules` (loading/empty/error/success)
- `DesignConstraints` (3~5)

#### R2 (UX Risks & Alternatives)
- `UXRisksTop3`
- `DesignAlternatives` (정확히 2안 A/B):
  - Option / Pros / Cons / CostOrComplexity
- `DecisionAsks` (<=2)  # PM이 결정해야 할 포인트

#### R3 (Handoff & QA)
- `HandoffChecklist` (<=10)
- `AcceptanceCriteria` (<=5)
- `QAPlan` (<=5 lines)

### 4.3 Tech Lead
#### R1 (Architecture Sketch)
- `ArchitectureSketch`
- `APIsAndDataModel` (핵심만)
- `ImplementationSteps` (3~6)
- `TechRisksTop3`

#### R2 (Risks & Mitigations — NewOnly)
- `RisksTop3_NewOnly`  # R1과 동일 항목 반복 금지
- `Mitigations`
- `FeasibilityCheck` (Go/Conditional/No-Go + 이유 1~2줄)
- `DisproofQuestions` (>=2)

#### R3 (Build/Release Commit)
- `BuildPlan` (<=7 steps)
- `TestingPlan` (<=5 bullets)
- `ReleasePlan` (<=5 bullets)
- `KnownLimitations` (<=3)

### 4.4 Delivery Manager (PM)
#### R1 (Milestone Draft)
- `PriorityDecision` (<=3)
- `Milestones` (<=4, 조건부 허용)
- `ResourcingAssumptions` (<=3)
- `DecisionLog` (<=3)

#### R2 (Tradeoff Decision)
- `Tradeoffs` (<=3)
- `Decision` (Go/Conditional/No-Go)
- `Conditions` (Conditional일 때만 <=5)
- `DecisionLog` (<=5)

#### R3 (Final Plan)
- `FinalScope`
- `Timeline` (주/일 단위)
- `Owners` (PRD/UX/Tech/DM 책임 매핑)
- `RisksAndMitigations` (<=5)
- `SuccessMetrics` (<=3)
- `DecisionLog` (<=7)

---

## 5) Rewrite(중복 70%) 가드 — 비교 기준을 “항목 단위”로 고정
### 5.1 중복 판단 기준(우선순위)
1) 리스트 필드(예: RisksTop3, KeyScreens, Milestones)의 **항목 단위 중복률**을 1차 기준으로 사용  
2) 텍스트 유사도는 2차(보조)로만 사용 (불안정 방지)

### 5.2 동작 규칙
- 중복률 >= 70%이면 서버가 1회 자동 rewrite 요청
- rewrite 1회 실패 시:
  - `RepeatedContentCheck = NOT_OK`로 기록
  - USER_GATE로 회귀하여 steering 또는 focus 조정을 유도

---

## 6) CaseFile 스키마 확장 (dev_project 안정화)
dev_project 세션에서 CaseFile은 다음을 분리 저장한다.

### 6.1 권장 CaseFile 필드
- `session_id`
- `schema_version: "devproject-2.1"`
- `project_type: "dev_project"`
- `current_round`
- `phase`
- `turn_index`

**누적(핵심)**
- `decisions_so_far: string[]`
- `scope_in: string[]`
- `scope_out: string[]`
- `risks_so_far: string[]`
- `ux_artifacts_summary: { flow: string, key_screens: string[] }`
- `tech_artifacts_summary: { architecture: string, apis: string[] }`

**Steering**
- `steering_history: Array<{ raw_text, normalized, status, conflicts, timestamp }>`
- `committed_steering_snapshot: { focus, goal, constraints, changes }`

**운영/디버깅**
- `last_round_end_payload`  # SSE 재연결/요약 UI에 사용
- `last_agent_outputs` (선택: 최근 1라운드만 저장)

---

## 7) /report 최종 결과물(JSON 스키마 고정)
최종 리포트는 Markdown 우선이 아니라 JSON 구조를 우선 생성하고 UI는 JSON 기반으로 렌더링한다.

### 7.1 FinalReport JSON 필드
- `executive_summary`
- `final_scope`
- `ux_spec_summary`
- `tech_architecture_summary`
- `timeline_and_owners`
- `risks_and_mitigations`
- `decision_log`
- `open_issues` (pending 포함)
- `next_experiments`

---

## 8) 구현 반영 위치(파일 단위 변경 지시)
### 8.1 Backend
- `backend/orchestrator/state_machine.py`
  - project_type별 전이표 분리 유지
  - USER_GATE에서만 라운드 증가 규칙 유지

- `backend/orchestrator/steering/normalizer.py`
- `backend/orchestrator/steering/guard.py`
- `backend/orchestrator/steering/committer.py`
  - pending 정책/연속 제한 반영

- `backend/api/routes.py`
  - `ROUND_END` 이벤트 발송 시 **ROUND_END_PAYLOAD 고정 스키마** 적용
  - pending 시 USER_GATE에 conflicts/questions 전달
  - rewrite 가드(항목 단위 중복률) 적용

- `backend/agents/devproject/*`
  - 라운드별 출력 스키마 강제(섹션/필드 누락 시 rewrite)
  - 답변 말미 Steering Compliance Check 포함

### 8.2 Frontend
- `app/session/[id]/page.tsx`
  - `ROUND_END_PAYLOAD`를 수신하여 GateSummaryCard 렌더
  - USER_GATE에서 pending 발생 시 Fix now / Proceed with defaults UI 제공
  - steering_questions(<=2) 표시

- `DevProjectGateForm`
  - 최소 필수 입력만(필수 2~3개) + Advanced 접힘
  - pending이면 conflicts 표시 + quick fix 입력

- `/report`
  - FinalReport JSON 렌더링 컴포넌트

---

## 9) 완료 기준(DoD)
- [ ] R1/R2 종료 시 ROUND_END_PAYLOAD가 UI에 표시되어 steering 입력을 유도한다.
- [ ] pending이 발생하면 “Fix now / Proceed with defaults”로 사용자가 진행할 수 있다.
- [ ] pending 연속 2회 발생 시 자동 defaults로 진행하여 정체를 방지한다.
- [ ] R2/R3에서 라운드별 스키마가 지켜지고, 중복 70% 이상이면 1회 rewrite가 동작한다.
- [ ] CaseFile에 decisions/scope/risks/steering_history가 분리 저장되어 다음 라운드에 안정적으로 반영된다.
- [ ] /report는 JSON 기반으로 최종 결과를 렌더링한다.

---
