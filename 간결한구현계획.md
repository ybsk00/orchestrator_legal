# AntiGravity 전달용 최종 수정안 (v1.0)
목표: Agent1↔Agent2 반복 루프를 제거하고, 라운드별 역할/출력 구조를 고정하여 3라운드 내 수렴(Convergence)을 강제한다.  
핵심: **라운드별 프롬프트/출력 스키마 분리 + 상태머신 호출 순서 고정 + 서버 가드레일(중복/금칙 위반 재작성)**

---

## 0) 문제 요약(현재 증상)
- Agent1과 Agent2의 발언이 반복되며 라운드가 불필요하게 길어짐.
- 원인 3가지:
  1) Agent1 규칙이 “항상 MVP/KPI 포함”과 “2라운드 이후 MVP 금지”가 충돌(동일 에이전트에 상충 규칙).
  2) 금지어를 길게 나열해 오히려 동일 문구 회귀(네거티브 프라이밍).
  3) 상태머신/오케스트레이터가 라운드 중간에도 Agent1을 재호출하여 “초안 제시 역할”이 반복됨.

---

## 1) 최종 정책(운영 규칙)
### 1.1 라운드 제한
- 기본: **총 3라운드(MaxRounds=3)**
- 라운드 3에서 무조건 결론(Go/Conditional Go/No-Go) 산출.

### 1.2 에이전트 호출 원칙(반복 방지 핵심)
- **Agent1은 라운드 1에서만 “초기 계획”으로 1회 호출**
- 라운드 2~3에서는 Agent1 호출을 원칙적으로 금지(필요 시 “Patch 전용 프롬프트”로만 호출)
- 라운드 종료는 항상 `WAIT_USER` 상태로 귀결(사용자 입력 전까지 자동 루프 금지)

---

## 2) 상태머신(Phase) 최종 전이표 (3라운드 수렴)
> 서버는 아래 순서를 강제한다. (에이전트 응답 종료 후 자동으로 다음 phase로 진행하되, 라운드 종료 시 WAIT_USER에서 멈춘다.)

### Round 1 (초안 생성)
1) A1_R1_PLAN (Agent1)
2) A2_R1_CRIT (Agent2)
3) A3_R1_SYN  (Agent3)
4) V_R1_AUDIT (Verifier)
→ WAIT_USER (라운드 1 종료)

### Round 2 (패치/수렴)
1) A2_R2_CRIT (Agent2: “새로운/남은 리스크만”)
2) A3_R2_SYN  (Agent3: 패치 반영 v2)
3) V_R2_GATE  (Verifier: Gate 판정)
→ WAIT_USER (라운드 2 종료)

### Round 3 (최종 결정문)
1) A2_R3_LASTCHECK (Agent2: 최종 경고 1~2개)
2) A3_R3_FINAL     (Agent3: 최종안 문서)
3) V_R3_SIGNOFF    (Verifier: 승인/조건/거절)
→ FINALIZE_DONE (최종 페이지 이동)

#### 중요: Agent1 재호출 금지
- Round2/Round3 phase 목록에 Agent1이 절대 포함되지 않도록 고정한다.
- “사용자가 기능추가 의견”을 낼 경우에도, 다음 라운드 시작은 Agent2부터 진행(Agent1은 별도 트랙이 아니라면 호출하지 않는다).

---

## 3) 라운드별 역할 정의 및 출력 스키마(강제)
핵심: “무엇을 말하라”가 아니라 “무엇을 출력하라”를 고정하여 반복을 구조적으로 차단한다.

### 3.1 Agent1 (구현계획 전문가) — Round 1 ONLY
**역할:** 초기 MVP/구현계획 1회 제시  
**출력 스키마(고정):**
- MVP_Scope: (3~5 bullet)
- Milestones: (최대 4단계)
- Resources: (역할/인원/툴)
- KPI: (최대 3개, 측정 방법 포함)
- Open_Assumptions: (최대 3개)

**금지(라운드 2+):** Agent1을 호출하지 않는다.

### 3.2 Agent2 (리스크 오피서)
**공통 역할:** Agent1/Agent3 산출물의 허점/리스크를 비판  
**공통 출력 스키마(고정):**
- Top_Risks: (최대 3개, “이전과 중복 금지” 규칙 적용)
- Failure_Scenario: (1개)
- Disproof_Questions: (최소 2개)

**라운드별 추가 규칙**
- R1: 초안의 치명 리스크 Top3
- R2: “새로운 리스크 또는 남은 리스크만” (기존 Top3 재반복 금지)
- R3: 최종 경고 1~2개만 (길게 확장 금지)

### 3.3 Agent3 (합의안 설계자)
**역할:** A1 계획 + A2 리스크를 반영하여 절충/개선안 도출 및 최종 결정문 작성  
**라운드별 출력 스키마(고정):**
- R1: Synthesis_v1 / Risk_Mitigations / Next_Steps
- R2: Synthesis_v2 / Tradeoffs / Decision_Draft(Go/Conditional/No-Go 초안)
- R3: Final_Decision / Plan(<=5) / Metrics(<=3) / Risks_and_Mitigations / Timeline(3줄 이내)

### 3.4 Verifier (검증관)
**역할:** 결론을 “검증 가능한 형태”로 만들고, 게이트 판정 및 최종 서명  
**라운드별 출력 스키마(고정):**
- R1: Assumptions_To_Verify / Evidence_Needed / Feasibility_Check / Round2_Focus
- R2: Gate_Status(Go/Conditional/No-Go) / Conditions(<=3) / Remaining_Unknowns(<=2)
- R3: Signoff(Approved/Conditional/Rejected) / Conditions(<=3) / Audit_Summary(3줄)

---

## 4) 프롬프트 수정 원칙(네거티브 프라이밍 제거)
- 금지어/금지문구를 길게 나열하지 않는다.
- 라운드 2+에서 Agent1 “MVP/KPI 금지”를 말로 막지 말고,
  - **Agent1 호출 자체를 제거**하거나
  - Patch 전용 프롬프트로 분리해 출력 필드에서 MVP/KPI 항목을 제거한다.

---

## 5) 서버 가드레일(필수: 반복/규칙 위반 자동 차단)
### 5.1 Agent2 반복 방지(중복 리스크 태그)
- CaseFile에 `criticisms_so_far`(리스크 태그 목록)를 누적 저장
- Agent2 호출 시 입력에 포함
- 응답에서 Top_Risks가 기존 태그와 중복되면:
  - 서버가 “중복 리스크 재작성” 메시지로 1회 자동 재요청(Rewrite)

### 5.2 Agent3 반복 방지(결론 드리프트)
- CaseFile에 `decisions_so_far`(결론 요약) 누적
- Agent3가 이전 결론과 충돌하는 경우:
  - “충돌 사유/변경 근거” 필드가 없으면 재작성 요구

### 5.3 Phase/Turn 중복 실행 방지(동시성)
- session_id 단위 락/큐로 한 번에 1턴만 실행
- WAIT_USER 상태에서 자동 진행 금지(사용자 메시지 수신만 트리거)

---

## 6) CaseFile 업데이트 규칙(라운드 종료 시점 고정)
- 라운드 종료 시점 = Verifier 단계 종료 후
- 서버가 CaseFile을 갱신:
  - decisions/openIssues/assumptions/nextExperiments 최소 4종 강제
  - 길이 제한: 800~1200자 내 요약(프롬프트 입력 안정성)

---

## 7) 최종 완료 기준(Definition of Done)
- [ ] MaxRounds=3로 동작하며 라운드 3에서 항상 Finalize 완료
- [ ] Agent1은 Round1에서만 호출되고 Round2/3에는 호출되지 않는다
- [ ] Agent2는 criticisms_so_far 기반으로 중복 리스크를 반복하지 않는다(중복 시 서버 Rewrite)
- [ ] WAIT_USER에서 자동 루프가 발생하지 않는다(사용자 입력 전 진행 금지)
- [ ] 최종 결과물은 Verifier Signoff 포함하여 `/final` 페이지에서 요약 렌더링된다

---

## 8) 구현 변경 체크리스트(파일 단위)
- backend/orchestrator/state_machine.py
  - Phase 전이표를 본 문서대로 교체
  - WAIT_USER 트리거를 “사용자 입력”으로만 제한
- backend/prompts/
  - Agent1: Round1 전용 프롬프트만 유지(또는 R2+ Patch 프롬프트 별도 파일)
  - Agent2/3/Verifier: 라운드별 출력 스키마 강제
- backend/orchestrator/case_file_updater.py
  - criticisms_so_far, decisions_so_far 누적 추가
  - 라운드 종료 시점 갱신 고정
- backend/orchestrator/turn_manager.py
  - session_id 락/큐 + 중복 실행 방지 유지
- backend/api/events.py
  - 라운드 종료/최종화 이벤트 안정 송출

---
