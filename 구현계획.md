# 사내 법무 시뮬레이터(모의 재판) 오케스트레이터 — 역할/프롬프트 교체 구현 지시서 (AntiGravity용 v1.0)
목표: 어제 구축한 오케스트레이터(STATE/USER_GATE/END_GATE/Steering/Rewrite 가드레일 포함)를 **그대로 복사**하고, “법무 시뮬레이션(모의 재판)” 용도로 **역할(Agents)과 프롬프트만 교체**하여 빠르게 MVP를 만든다.

---

## 0) 전제(유지하는 기존 기능)
아래 기능은 기존 오케스트레이터에서 그대로 유지한다.
- 상태 분리: WAIT_USER / USER_GATE / END_GATE
- 라운드 진행: Round1~3 (기본 3라운드) + optional extend(1회)
- Steering: 사용자 제약/목표를 다음 라운드 프롬프트 최상단에 강제 주입
- 가드레일: Steering 위반 시 서버 1회 Rewrite 자동 재시도
- SSE: ROUND_END payload로 GateSummaryCard 즉시 렌더링
- 세션 락 + request_id 아이들포턴시

---

## 1) 프로젝트 복사/브랜치
### 1.1 폴더 복사
기존 orchestrator 프로젝트를 다음 경로로 복사:
- `orchestrator_legal/` (새 루트) 또는 기존 루트에서 `apps/legal_sim/` 형태로 분기

### 1.2 GitHub 브랜치/네이밍(권장)
- repo: `legal-sim-orchestrator` (또는 기존 repo 내 feature 브랜치)
- branch: `feature/legal-simulator-v1`

---

## 2) 사건 유형별 역할 세트(중요)
사용자가 “형사/민사” 중 무엇인지 선택하면, 시스템이 역할 세트를 자동 구성한다.
- 형사: Judge / Prosecutor / DefenseCounsel / Defendant
- 민사: Judge / PlaintiffCounsel / DefendantCounsel / PartyRep(당사자)
> NOTE: 기존에 “검사”를 민사에도 쓰는 것은 비정합이므로 민사에서는 “상대변호사(DefendantCounsel)”로 대체한다.

---

## 3) 신규/수정 파일 목록
### 3.1 신규: roles & prompts
- `backend/prompts/legal/role_prompts.py`  (신규)
  - 형사/민사 역할별 시스템 프롬프트 템플릿 정의
- `backend/prompts/legal/rubrics.py` (신규)
  - 출력 품질 루브릭(근거/절차/불확실성 표시/금지사항)

### 3.2 수정: agents
- `backend/agents/agent1_planner.py` → **legal_agent_judge.py** 로 대체(권장)
- `backend/agents/agent2_critic.py` → **legal_agent_opposing.py** 로 대체
- `backend/agents/agent3_synthesizer.py` → **legal_agent_synth.py** 로 대체
- `backend/agents/verifier.py` → **legal_agent_verifier.py** 로 대체(또는 기존 verifier 확장)

> 빠른 구현을 위해 “파일 복사 후 내부 프롬프트/role_name만 변경”으로 진행한다.

### 3.3 수정: 라우팅/세션 모델
- `backend/models/session.py`
  - `case_type`: `"civil" | "criminal"`
  - `jurisdiction`: 기본 `"KR"` (필요 시 확장)
  - `facts_stipulated`: bool (사실관계 고정 완료 여부)
- `backend/api/routes.py`
  - 세션 생성 시 case_type 입력받기
  - case_type에 따라 agent set 로드

---

## 4) 핵심 UX: “사실관계 고정(Fact Stipulation)” 단계 추가 (필수)
법무 시뮬레이션은 사실이 흔들리면 답이 산으로 간다.
따라서 Round1 시작 전에 반드시 “Facts 단계”를 넣는다.

### 4.1 새 Phase 추가(권장)
- `FACTS_INTAKE` (사용자 입력 수집)
- `FACTS_STIPULATE` (모델이 사실을 3분류로 정리)
  - Confirmed Facts (확정)
  - Unknown/Disputed (불명/쟁점)
  - Needed Evidence (필요 증빙)

### 4.2 동작
- 세션 생성 직후:
  - 사용자에게 “사건 개요/당사자/쟁점/증거”를 입력받게 함
- FACTS_STIPULATE 결과를 CaseFile에 저장하고,
- 이후 라운드의 모든 에이전트는 “Confirmed Facts만 전제”로 주장/판단하도록 강제

---

## 5) 라운드 상태머신(권장: 3라운드)
### 5.1 형사(권장)
- Round1: Prosecutor → Defense → Judge → USER_GATE
- Round2: Prosecutor(입증계획) → Defense(반증/절차) → Judge(쟁점/입증책임) → USER_GATE
- Round3: Defense(최종변론) → Prosecutor(최종변론) → Judge(판단/권고) → END_GATE

### 5.2 민사(권장)
- Round1: PlaintiffCounsel → DefendantCounsel → Judge → USER_GATE
- Round2: PlaintiffCounsel(입증/손해) → DefendantCounsel(항변/반증) → Judge(쟁점/입증책임) → USER_GATE
- Round3: 최종변론(양측) → Judge(판결 전망/합의안) → END_GATE

> NOTE: 기존 “Agent1은 Round1만 호출” 구조를 유지하되, 법무 시뮬에서는 Round1부터 “상대 주장”이 중요하므로,
> Round2/3에서도 양측 변호사 역할이 계속 나오게 설계한다(대신 중복 방지는 스키마/태그/Verifier로 통제).

---

## 6) 에이전트 역할 정의(프롬프트 교체)
아래는 최소 역할 4개(사건 유형에 따라 3~4개 선택)

### 6.1 Judge(재판장) — role_name: `judge`
역할:
- 절차 통제, 쟁점 확정, 입증책임 정리
- 결론은 “가능성/리스크/권고안” 형태로 제시 (확정적 자문 금지)
필수 출력 섹션(스키마 고정):
- `Issues` (쟁점)
- `Findings` (사실관계 판단: Confirmed Facts 기반)
- `BurdenOfProof` (입증책임)
- `DecisionRange` (승/패 가능성 범위, 조건부 표현)
- `RecommendedNextSteps` (사내 법무 액션)
- `Citations` (사내 문서/조항/증거ID, 없으면 “No citation” 명시)

금지:
- 없는 법령/판례를 만들어 내지 말 것
- “확정적 법률 자문” 문장 금지

### 6.2 Prosecutor / PlaintiffCounsel — role_name: `claimant`
역할:
- 주장 구성(요건사실/구성요건), 입증계획 제시
필수 출력:
- `Claims`
- `LegalElements` (요건/구성요건)
- `EvidencePlan` (증거ID 기반)
- `WeakPoints` (스스로 약점 1~2개)

### 6.3 DefenseCounsel / DefendantCounsel — role_name: `opposing`
역할:
- 반박/항변, 절차 위반/증거 배제/반증 전략
필수 출력:
- `CounterArguments`
- `DisproofPlan`
- `ProceduralRisks`
- `SettlementOptions` (민사일 때만)

### 6.4 PartyRep / Defendant — role_name: `party`
역할:
- 사실관계 보완 질문에 답하는 “사용자 대리” 에이전트 (선택)
원칙:
- 임의 사실 생성 금지
- “사용자 입력/증거팩” 범위 밖은 Unknown 처리

---

## 7) Steering(사용자 개입) 적용 방식(유지 + 법무 특화)
USER_GATE에서 사용자가 입력하는 Steering 예시:
- Goal: `risk_min`(리스크 최소) / `win_rate`(승소 확률) / `settlement`(합의 우선)
- Constraints: `deadline_2weeks`, `budget_limit`, `no_external_counsel`
- Exclusions: `no_aggressive_position`, `no_personal_data_exposure`
- Focus Issue: open_issues 중 1개 선택

Steering Block은 모든 에이전트 시스템 프롬프트 최상단에 강제 주입한다.

---

## 8) 법무 전용 가드레일(추가 권장)
기존 Steering 위반 Rewrite 외에 아래 2개를 추가한다.

### 8.1 “허위 인용” 방지 룰
- Citations 섹션이 비어있거나 “추정 판례/조문”이 등장하면
  - Verifier가 `Conditional` 또는 `No-Go`로 판정
  - 또는 1회 Rewrite로 “인용 없이 일반론”으로 재작성

### 8.2 “확정적 자문” 방지 룰
- “반드시/확실히/100% 승소” 등 확정 표현 감지 시 Rewrite(1회)

---

## 9) 프론트 UI 변경(최소)
- session 생성 화면에 `case_type` 선택 추가(형사/민사)
- FACTS_INTAKE 화면(사용자 입력 폼):
  - 사건 개요
  - 당사자
  - 요구사항(목표)
  - 보유 증거(파일/텍스트)
- Round End Gate UI는 기존 GateSummaryCard 그대로 사용

---

## 10) 수동 테스트 시나리오(필수)
1) 세션 생성 → case_type=민사 선택
2) FACTS 입력(계약 분쟁 예시) → FACTS_STIPULATE 결과 확인
3) Round1 진행 후 USER_GATE 표시 확인
4) Steering 입력: “합의 우선, 2주 내 마무리” → Round2에서 반영 확인
5) Round3 종료 후 END_GATE에서 finalize 선택 → 리포트 생성 확인
6) 금지사항 테스트: “확정 승소” 표현 유도 → Rewrite 동작 로그 확인

---

## 11) 완료 기준(DoD)
- [ ] case_type에 따라 역할 세트가 자동 구성된다(형사/민사)
- [ ] Round 시작 전 FACTS_STIPULATE 단계가 존재하고, 이후 라운드는 Confirmed Facts만 전제로 진행된다
- [ ] USER_GATE/END_GATE가 정상 동작하며, steering 입력이 다음 라운드 프롬프트 최상단에 주입된다
- [ ] 확정적 자문/허위 인용 방지 가드레일이 동작한다(1회 Rewrite + Verifier 판정)
- [ ] 최종 리포트(/report)는 “쟁점/리스크/권고 액션” 중심으로 요약된다

---
# 라운드별 사용자 입력(의견) 강제 반영 + 법무용 입력필드(UI) 개편 지시서 (AntiGravity용 v1.0)
목표: 법무 시뮬레이터(모의 재판)에서 **매 라운드마다 사용자 입력을 받되**, 사용자의 의견이 “참고”가 아니라 **재판 진행 방향을 결정하는 Steering(강제 제약)** 으로 반영되도록 한다.  
핵심: 라운드마다 “자유발화”를 요구하기보다, **법무에 맞는 정형 입력필드(쟁점/입증/목표/양보선)** 로 방향을 고정한다.

---

## 1) 정책 변경: 매 라운드 종료 후 USER_GATE는 “필수”
- 기존: USER_GATE에서 Skip 기본값, 입력은 옵션
- 변경: 법무 시뮬에서는 **매 라운드마다 사용자 확인/입력**을 받는다
  - 단, 사용자 부담을 줄이기 위해 **선택형(칩/체크박스) 기반**
  - 사용자가 정말 할 말이 없을 때만 “스킵(그대로 진행)” 허용

### 적용
- Round1 종료 → USER_GATE_REQUIRED
- Round2 종료 → USER_GATE_REQUIRED
- Round3 종료 → END_GATE_REQUIRED

> NOTE: 상태명은 유지해도 되지만, 프론트에서 “입력 필수” 플래그를 내려받아 UI를 강제한다.
- `gate_required: true` (ROUND_END payload에 포함)

---

## 2) 법무용 USER_GATE 입력폼(핵심)
라운드별로 사용자 입력이 달라야 “올바른 방향”으로 흐른다.  
따라서 USER_GATE 패널을 **Round별 폼 스키마**로 분리한다.

### 공통 구성(모든 라운드)
- (A) 사건 유형/관할: 표시만(읽기 전용)
- (B) 이번 라운드 요약: decision_summary / what_changed / open_issues (ROUND_END payload 사용)
- (C) **사용자 Steering 입력(필수)**: 아래 항목
- (D) 제출 버튼: “이 방향으로 다음 라운드 진행”

---

## 3) Round별 입력필드 설계(정형화)
### 3.1 Round1 Gate: “쟁점 확정 + 목표 설정”
**목적:** 처음 산으로 가는 걸 막기 위해 “핵심 쟁점 1~2개”를 사용자가 확정한다.

필드:
1) `핵심 쟁점 선택` (필수, 최대 2개)
   - open_issues 목록에서 선택(체크박스)
2) `목표(Goal)` (필수, 단일 선택 칩)
   - `승소가능성 극대화` / `리스크 최소화` / `조기 종결(합의/조정)` / `증거 보강 우선`
3) `포지션(주장 강도)` (필수, 단일 선택)
   - `강경` / `중립` / `유연(협상)`  
4) `절대 금지(Exclusions)` (옵션, 복수 선택)
   - `개인정보 노출 금지`
   - `공격적 표현 금지`
   - `외부 로펌/자문 언급 금지`
5) `추가 사실/정정(Free text)` (옵션, 300자)
   - “사실관계 수정이 있으면 여기만 입력”

저장되는 Steering 예:
```json
{
  "focus_issues": ["issue-2", "issue-3"],
  "goal": "settlement",
  "stance": "flexible",
  "exclusions": ["no_personal_data_exposure"],
  "note": "손해액은 아직 확정되지 않았고, 상대가 먼저 제안한 합의금이 있습니다."
}
