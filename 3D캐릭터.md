# AntiGravity 작업지시서: 3D 캐릭터 패널(좌) + 채팅(우) 토론 UI 연동 (정석: 3D 모델 + 코딩 제어)
버전: v1.0  
목표: 좌측에 3D 캐릭터 3명(Agent1/2/3)을 WebGL로 상시 렌더링하고, 우측 채팅에서 “현재 발화자(activeSpeaker)” 이벤트에 따라 **해당 캐릭터만 Speaking 애니메이션**으로 전환. 대화/토론은 SSE 기반, 조기 종료 시 즉시 Finalize 후 `/final` 페이지로 라우팅.

---

## 0) 범위/전제
- 프론트: React(권장 Next.js App Router)
- 3D 렌더: Three.js 기반 `@react-three/fiber` + `@react-three/drei`
- 서버: FastAPI + SSE(이미 설계된 orchestrator/events 활용)
- 캐릭터 모델: **GLB/GLTF** (리깅 + 애니메이션 포함)
- 최소 애니메이션: `Idle`, `Talk`(혹은 `Speak`) 2종 (루프 가능)

---

## 1) 필요한 3D 에셋 스펙(필수)
### 1.1 캐릭터 파일
- 파일: `agent1.glb`, `agent2.glb`, `agent3.glb`
- 포함 요소:
  - 스켈레톤 리깅(인간형/캐릭터)
  - 애니메이션 클립 2개 이상: `Idle`, `Talk`
  - 단일 메쉬 또는 서브메쉬 가능(단, 드로우콜 최적화 권장)

### 1.2 권장 기술 스펙(성능)
- 폴리곤: 캐릭터당 30k~80k tris 권장(최대 120k 이하)
- 텍스처: 1K~2K (필요 시 4K는 지양)
- 파일 용량: 캐릭터당 10~25MB 이하 권장
- 압축: 가능하면 `draco`/`ktx2` 적용(후속 최적화 단계에서)

### 1.3 네이밍 규칙(강제)
- 애니메이션 클립 이름은 다음 중 하나로 통일:
  - `Idle`
  - `Talk` 또는 `Speak` (둘 중 하나로 통일)
> 애니메이션 이름이 다르면 코드에서 매핑 테이블을 추가해야 하므로, 가능하면 통일.

---

## 2) 화면 구성(UX)
### 2.1 레이아웃
- 좌측 40%: 3D 캐릭터 패널(ScenePanel)
- 우측 60%: 채팅 패널(ChatPanel)
- 우측 상단: `마무리하기` 버튼(조기 종료)

### 2.2 캐릭터 연출 규칙
- 기본 상태: 모든 캐릭터 `Idle` 루프
- 발화 상태: activeSpeaker의 캐릭터만 `Talk` 루프
- 비발화 캐릭터: `Idle` 유지
- 시각 강조(최소 1개 적용):
  - 발화자 주변 라이트 강화 OR outline/glow OR 살짝 카메라 줌/패닝

---

## 3) 프론트엔드 구현(React + r3f)
### 3.1 설치 패키지
- `three`
- `@react-three/fiber`
- `@react-three/drei`

### 3.2 파일 구조(권장)
- `app/session/[id]/page.tsx` : 메인 토론 페이지(좌 3D + 우 채팅)
- `components/scene/ScenePanel.tsx` : 3D 전체 씬
- `components/scene/AgentAvatar.tsx` : 단일 캐릭터 로더/애니메이션 컨트롤
- `components/chat/ChatPanel.tsx` : SSE 기반 채팅 UI
- `lib/sse.ts` : SSE 클라이언트(Last-Event-ID 포함)

### 3.3 ScenePanel 요구사항(필수)
- `<Canvas>`를 사용해 WebGL 렌더
- 카메라: PerspectiveCamera (FOV 35~50 권장)
- 라이트: Ambient + Key(Spot/Directional) + Fill(선택)
- 바닥/배경: 간단한 plane 또는 스튜디오 느낌 HDRI(가벼운 구성)
- 캐릭터 배치:
  - 좌/중/우(또는 전면 3명)로 고정 배치
  - 서로 겹치지 않게 거리/스케일 조정

### 3.4 AgentAvatar 요구사항(핵심)
- GLB 로드: `useGLTF('/models/agent1.glb')` 등
- 애니메이션: `useAnimations(animations, groupRef)`
- 상태 입력: `isSpeaking: boolean`
- 동작:
  - `isSpeaking=false` => Idle로 fade-in 전환
  - `isSpeaking=true`  => Talk로 fade-in 전환
- 전환 품질:
  - `fadeIn(0.2~0.4s)`, `fadeOut(0.2~0.4s)` 적용
  - 루프 설정: `THREE.LoopRepeat`

> 주의: 애니메이션이 없거나 이름이 다르면 fallback(Idle만 재생) 처리 필수.

---

## 4) 백엔드 이벤트 연동 규격(SSE)
### 4.1 SSE 엔드포인트
- 예: `GET /api/session/{id}/events` (이미 설계된 events.py 사용)

### 4.2 프론트가 수신해야 하는 이벤트(최소)
1) `speaker_change`
- payload: `{ activeSpeaker: "agent1" | "agent2" | "agent3" | "none" }`
- 목적: 3D 캐릭터 speaking 상태 전환

2) `message`
- payload: `{ role, phase, content, reasoningSummary, event_id }`
- 목적: 채팅 렌더

3) `finalize_done`
- payload: `{ finalUrl: "/session/{id}/final" }`
- 목적: 최종 페이지로 라우팅

### 4.3 Last-Event-ID(권장)
- 프론트는 마지막 `event_id`를 저장
- SSE 재연결 시 헤더로 `Last-Event-ID` 전송
- 서버는 해당 이후 이벤트만 재전송(최소: 턴 종료 이벤트라도 보장)

---

## 5) 조기 종료(마무리하기) UX/동작
- 버튼 클릭 시:
  - `POST /api/session/{id}/stop` 호출
  - 서버는 진행 중 턴 스트리밍 중단 + Agent3 Finalizer 실행
  - `finalize_done` 이벤트 발생 시 `/final` 이동
- 텍스트 종료는 `/stop`, `/final` 같은 명령어 방식으로 제한(오탐 방지)

---

## 6) 품질/성능 필수 체크
### 6.1 성능
- Canvas는 좌측 패널만 사용(전면 전체 X)
- DPR 제한(예: `dpr={[1, 1.5]}`) 권장
- 그림자(shadow)는 MVP에선 OFF 또는 최소화
- 모델 로딩은 Suspense + 로딩 UI 제공

### 6.2 안정성
- 모델 로드 실패 시:
  - “3D 로드 실패” 안내 + 이미지 fallback(선택)
- 애니메이션 없을 시:
  - Idle 고정 + 하이라이트로 speaking 표현(대체)

---

## 7) 완료 기준(Definition of Done)
- [ ] 좌측 패널에 3명의 3D 캐릭터가 상시 보인다(Idle 루프).
- [ ] SSE `speaker_change` 수신 시 해당 캐릭터만 Talk로 전환되고 나머지는 Idle 유지한다.
- [ ] 우측 채팅에 Agent1/2/3 메시지가 순서대로 표시된다.
- [ ] `마무리하기` 클릭 시 즉시 토론이 중단되고 Finalizer가 실행되며 `/final`로 이동한다.
- [ ] `/final` 페이지에서 Agent3 최종 결과물이 요약 렌더링된다.
- [ ] SSE 재연결 시 lastEventId 기반으로 메시지 유실이 최소화된다(최소 턴 종료/최종화 이벤트 보장).

---

## 8) 작업 순서(권장)
1) 3D 에셋 확보(GLB 3개, Idle/Talk 포함) 및 `/public/models/` 배치
2) ScenePanel + AgentAvatar 컴포넌트로 로딩/애니메이션 전환 구현
3) SSE 클라이언트 연결 및 `speaker_change` 이벤트 수신 → 3D 상태 연동
4) 채팅 UI 렌더링(에이전트 배지/논리요약)
5) 조기 종료 버튼 + finalize_done 라우팅
6) 성능 최적화(DPR/라이트/텍스처) 및 로딩 UX

---
