# 사용자 발화(방향 제어) 기반 회의 진행 설계 — 통합 정리본 (AntiGravity 전달용 v1.0)
목표: 멀티에이전트 토론이 산으로 가지 않도록, **라운드 종료마다 사용자 개입(USER_GATE)을 제공**하고 사용자의 발화를 **강제 제약(steering)** 으로 주입하여 이후 라운드가 그 방향대로 진행되게 한다.  
핵심: “대화 히스토리 참고” 수준이 아니라 **Steering 블록(최상단 강제 주입) + 위반 감지/재작성 가드레일**로 보장한다.

---

## 1) 전체 UX/상태 흐름(권장)
### 1.1 USER_GATE 삽입 위치(라운드 종료 지점)
- Round 1 종료: `V_R1_AUDIT` 이후 `USER_GATE`
- Round 2 종료: `V_R2_GATE` 이후 `USER_GATE`
- Round 3 종료: `V_R3_SIGNOFF` 이후 `END_GATE`

### 1.2 상태 흐름(권장 시퀀스)
**Round 1**
A1_R1_PLAN → A2_R1_CRIT → A3_R1_SYN → V_R1_AUDIT → **USER_GATE** → (skip/input/finalize) → Round2 시작

**Round 2**
A2_R2_CRIT → A3_R2_SYN → V_R2_GATE → **USER_GATE** → (skip/input/finalize) → Round3 시작 또는 종료

**Round 3**
A2_R3_LASTCHECK → A3_R3_FINAL → V_R3_SIGNOFF → **END_GATE** → (finalize/extend/new_session) → FINALIZE_DONE

> 원칙: 라운드 종료 후 자동으로 다음 라운드로 흘러가지 않게 “게이트”를 둔다.

---

## 2) USER_GATE UI 구성(권장)
목적: 사용자 입력 부담 최소화 + 방향 제어 최대화

### 2.1 GateSummaryCard (필수)
라운드 종료 직후(채팅 내 시스템 카드 또는 모달) 표시:
- **Current Decision (1문장)**: 이번 라운드 결론 요약
- **What Changed (3 bullets)**: 변경점 상위 3개
- **Open Issues (최대 3개)**: 남은 쟁점(체크박스 포함)
- **Verifier Gate 상태 배지**: Go / Conditional Go / No-Go

추가 기능:
- Open Issues는 **1개 선택 가능(focus)**  
  → 다음 라운드에서는 해당 이슈 해결을 최우선으로 다룸

### 2.2 액션 버튼(3개만 유지)
1) **그대로 진행(스킵)** (Primary, 기본값)
2) **방향/조건 추가하기** (Secondary, 입력 패널 열기)
3) **지금 결론으로 마무리하기** (Tertiary, 조기 종료)

### 2.3 SteeringPanel (옵션, 기본 접힘)
“방향/조건 추가하기” 클릭 시 펼침:

- Chip 입력(권장)
  - Goal: `conversion` / `risk_min` / `speed`
  - Constraints: 예) `2_weeks`, `budget_200`, `legal_review_required`
  - Exclusions: 예) `no_cold_email`, `no_medical_copy_generation`
  - Priority: 예) `compliance > cost > speed`
- Free-text (보완): 300~500자 제한 권장
- Submit: “이 조건으로 다음 라운드 진행”

---

## 3) END_GATE UI(라운드 3 종료 후)
Round3 종료 후에는 USER_GATE 대신 END_GATE를 표시:

버튼 3개:
1) **최종 리포트 보기(종료)** (Primary, 기본값)
2) **1라운드만 더 진행(+1)** (Secondary, 연장 1회 제한 권장)
3) **새 세션으로 이어가기** (Tertiary: 결론 고정 후 새 토픽 시작)

규칙:
- extend는 `extend_count`로 제한(권장: 최대 1회)
- new_session은 기존 결론을 CaseFile로 고정 저장 후 새 세션 생성

---

## 4) 사용자 발화가 “회의 방향”으로 반영되는 원리(보장 장치)
사용자 발화/조건을 “참고용 텍스트”가 아닌 **강제 제약(steering)** 으로 처리한다.

보장 장치 3종:
1) USER_GATE에서 입력된 steering을 서버에 저장
2) 다음 라운드 시작 시 모든 에이전트 프롬프트 **최상단에 Steering 블록 강제 삽입**
3) 응답이 steering을 위반하면 서버가 **위반 감지 + 1회 자동 재작성(rewrite)**

---

## 5) Steering 데이터 모델(서버 저장)
USER_GATE에서 `action=input`이면 아래를 저장:
- `pending_steering` (object|null)
- `pending_user_text` (string|null)
- `focus_issue_ids` (list[str])
- `steering_version` (int, 업데이트마다 +1)

권장 형태:
```json
{
  "goal": "risk_min|speed|conversion",
  "constraints": ["2_weeks", "budget_200", "legal_review_required"],
  "exclusions": ["no_cold_email", "no_medical_copy_generation"],
  "priority": ["compliance", "cost", "speed"],
  "free_text": "추가 조건 텍스트",
  "focus_issue_ids": ["issue-1"]
}
6) Steering 정규화(권장: 1회 Non-stream)
사용자 입력이 모호할 수 있으므로 USER_GATE input 제출 시 1회만 정규화 수행:

정규화 결과(서버 저장):

steering_summary (2~3줄)

hard_constraints (최대 5개)

hard_exclusions (최대 5개)

예:

steering_summary: “법/규제 리스크 최소화가 최우선. 2주 내 MVP. 콜드메일 방식 제외.”

hard_constraints: ["legal_review_required", "2_weeks"]

hard_exclusions: ["no_cold_email"]

7) 모든 에이전트 프롬프트 최상단 “Steering 블록” 강제 주입
다음 라운드 시작 시(특히 Agent2부터) Agent2/Agent3/Verifier system prompt 상단에 아래 블록을 삽입한다.

7.1 Steering 블록 템플릿(공통)
css
코드 복사
## [USER STEERING — MUST FOLLOW]
Goal: {{goal}}
Priority order: {{priority}}
Hard constraints (must satisfy): {{hard_constraints}}
Hard exclusions (must not propose): {{hard_exclusions}}
Focus issue (if any): {{focus_issue}}

User note: {{steering_summary}}

### RULES
1) Hard constraints를 만족하지 못하는 제안은 실패입니다.
2) Hard exclusions에 해당하는 제안은 금지이며 포함되면 실패입니다.
3) Output은 Goal/Priority에 맞춰 최적화해야 합니다.
4) Focus issue가 있으면 해당 이슈 해결을 최우선으로 다루세요.
5) 응답 끝에 `Steering Compliance Check`로 준수 여부를 자가 점검하세요.
NOTE: 금지어 나열 대신 “제약 구조”를 상단에 고정하여 방향 이탈을 방지한다.

8) 사용자 입력 이후 라운드 시작 순서(권장)
USER_GATE에서 사용자가 입력했든/스킵했든, 다음 라운드는 원칙적으로 Agent2부터 시작한다.

이유:

사용자 조건을 먼저 “리스크 관점”으로 점검하여 산으로 가는 것을 차단

Agent3가 그 리스크를 반영해 절충안을 만들도록 유도

9) 서버 가드레일: 위반 감지 + 1회 자동 재작성(rewrite)
목표: steering 준수를 시스템적으로 보장한다.

9.1 위반 유형(최소)
Exclusion 위반: 금지된 제안 포함

Constraint 위반: 기간/예산/필수 절차 무시

Priority 위반: compliance 최우선인데 위험한 제안으로 치우침

Focus issue 무시: 선택된 open issue를 다루지 않음

9.2 위반 감지(권장 2단계)
룰/정규식 1차 감지 (빠름)

Non-stream 검증 호출(선택) (애매할 때만)

입력: steering + agent_output

출력(JSON): {"compliant": bool, "violations": [...], "fix_instructions": "..."}

9.3 재작성 정책
위반 시 응답 폐기 후 1회 재요청(rewrite)

재요청 지시문:

css
코드 복사
Your previous answer violated USER STEERING.
Violations: {{violations}}
Rewrite to fully comply with Hard constraints and Hard exclusions.
Do not mention the violations list in the final response.
1회 재작성에도 실패하면:

Verifier가 Conditional/No-Go로 처리하거나 즉시 종료(안전 우선)

10) 프론트 → 서버 이벤트 스키마(최소)
json
코드 복사
{
  "action": "skip|input|finalize|extend|new_session",
  "focus_issue_ids": ["issue-1"],
  "steering": {
    "goal": "risk_min|speed|conversion",
    "constraints": ["2_weeks", "budget_200"],
    "exclusions": ["no_cold_email"],
    "priority": ["compliance", "cost", "speed"]
  },
  "free_text": "추가 조건 텍스트"
}
서버 처리:

skip: 빈 입력(system_event=SKIP)으로 라운드 시작 트리거 생성

input: steering 저장 + 정규화 + 다음 라운드 진행

finalize: 즉시 FINALIZE_DONE → /report 이동

extend: extend_count 확인 후 1회 연장

new_session: 현재 세션 결론 고정 저장 후 새 세션 생성

11) 세션 상태 확장(권장)
pending_steering: object|null

pending_user_text: str|null

steering_summary: str|null

hard_constraints: list[str]

hard_exclusions: list[str]

focus_issue_ids: list[str]

user_gate_action: str

extend_count: int

steering_version: int

12) 완료 기준(DoD)
 Round 1/2 종료마다 USER_GATE가 표시되고 기본 선택은 “스킵”이다

 Open Issues는 최대 3개로 제한되며 1개 선택 시 다음 라운드 focus가 적용된다

 사용자 steering 입력 시 1회 정규화되어 hard_constraints/exclusions가 생성된다

 다음 라운드에서 Agent2/Agent3/Verifier 프롬프트 최상단에 Steering 블록이 강제 삽입된다

 응답이 steering을 위반하면 서버가 1회 자동 재작성(rewrite)한다

 Round 3 종료 후 END_GATE에서 종료/연장/새세션 선택이 가능하며, 최종 결과는 /report에 표시된다

makefile
코드 복사
::contentReference[oaicite:0]{index=0}