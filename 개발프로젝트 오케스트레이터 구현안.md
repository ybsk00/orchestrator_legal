# 개발 프로젝트 오케스트레이터 구현안 (AntiGravity 적용용 v1.0)
목표: 사용자 입력(매 턴 Steering)을 안전하게 반영하면서 **반복/산으로 감**을 최소화하는 4인 토론 오케스트레이터를 구축한다.  
구성: **PRD Owner / Tech Lead / UX Lead / Delivery Manager** (4인)

---

## 0) 핵심 원칙(반복 방지 + 수렴)
1. **역할 = 산출물 책임(Deliverable Owner)** 으로 정의한다. 서로 영역 침범 금지.
2. **3라운드 고정**(기본) + END_GATE에서 `extend_once`(1회)만 허용.
3. **매 턴 사용자 의견은 반드시 반영**하되, 원문을 그대로 주입하지 않고 **Steering Guard**로 정규화/검증 후 `committed`만 주입한다.
4. **출력 스키마 고정**으로 반복을 구조적으로 차단(금지어 나열 X).
5. 라운드 종료마다 **USER_GATE**에서 사용자가 “그대로 진행/방향 수정/마무리/연장”을 선택한다.
6. 모든 에이전트는 답변 끝에 `Steering Compliance Check: OK/NOT_OK`를 반드시 포함한다(Verifier는 별도 필드로 판단).

---

## 1) 역할 정의(겹침 방지 규칙 포함)
### 1.1 PRD Owner (기획 책임)
- 산출물: 문제정의, 목표/성공지표, 사용자 시나리오, 범위(In/Out), 요구사항(초안)
- 금지: 일정 확정, 리소스 확정, UI 디테일 확정

### 1.2 Tech Lead (개발 책임)
- 산출물: 아키텍처, 데이터모델/API, 기술 리스크 Top3, 구현 순서, 난이도 추정
- 금지: 요구사항 재정의, 일정 확정(Delivery 영역)

### 1.3 UX Lead (디자인 책임)
- 산출물: User Flow, IA, Key Screens, Interaction Rules(상태), Handoff/QA 기준
- 금지: 비즈니스 우선순위 결정(Delivery/PRD 영역)

### 1.4 Delivery Manager (PM 책임)
- 산출물: 트레이드오프 결정, 마일스톤/일정(조건부), 리소스 가정, Decision Log, 최종 커밋 플랜
- 금지: 신규 기능 제안(결정/정리에 집중)

---

## 2) 라운드/Phase 설계(3라운드 고정)
### 2.1 Round 1 (Define)
PRD_R1 → UX_R1 → TECH_R1 → DM_R1_SUMMARY → USER_GATE

### 2.2 Round 2 (Risk & Tradeoff)
TECH_R2_RISKS → UX_R2_RISKS → PRD_R2_SCOPE_ADJUST → DM_R2_DECISION → USER_GATE

### 2.3 Round 3 (Commit)
DM_R3_FINAL → TECH_R3_CHECK → UX_R3_QA → VERIFIER_R3_SIGNOFF → END_GATE → FINALIZE_DONE

> NOTE: Verifier는 최소로 두되, **R3에서만 “최종 수렴” 검증**을 강제한다.  
(원하면 R1/R2에도 Verifier Gate를 추가할 수 있으나, 반복/길이 증가 요인이므로 MVP는 R3 집중을 권장)

---

## 3) USER_GATE / END_GATE UX(사용자 개입)
### 3.1 USER_GATE(라운드 1,2 종료 시)
사용자 선택 버튼:
- `skip` : 그대로 진행
- `input` : 방향/제약 추가 후 진행
- `finalize` : 즉시 마무리(리포트)
- (옵션) `extend_once` : END_GATE에서만 노출 권장

### 3.2 END_GATE(라운드 3 종료 시)
- `finalize` : 최종 리포트 생성(/report)
- `extend_once` : 1회만 라운드 추가(예: Round4 “Delta Fix”)
- `new_session` : 현재 결론 고정 후 새 세션 생성

---

## 4) USER_GATE 입력폼(최소 필수 + Advanced)
원칙: 매 턴(라운드 종료) 사용자 의견을 받되 **필수는 2~3개만 강제**하고 나머지는 Advanced로 접는다.

### 4.1 Round1 USER_GATE (필수 2개)
- 필수: `Focus` (1개) / `Goal` (1개)
- 옵션(Advanced): `Constraints(0+)`, `MustHaveScreens(0+)`, `Notes(<=300자)`

### 4.2 Round2 USER_GATE (필수 3개)
- 필수: `Focus` (1개) / `Goal` (1개) / `Constraints(>=1)`
- 옵션(Advanced): `ScopeChange(add/remove)`, `Notes(<=300자)`

### 4.3 공통 선택지 예시
- Focus: `MVP범위 | 기술리스크 | UX전환 | 일정단축 | 안정성 | 비용절감 | 데이터/추적`
- Goal: `speed | quality | cost | learning(검증)`
- Constraints: `2주내 | 1~2인 | 외부API금지 | 보안필수 | 다크UI | 모바일우선`

---

## 5) Steering Guard(매 턴 반영 가드) — 필수 모듈
### 5.1 데이터 흐름
UserInput(raw) → **Normalizer** → **Guard** → Commit(committed/pending/rejected) → PromptInjection

### 5.2 Steering 모델(세션/CaseFile 저장)
- `raw_text`: 사용자 원문
- `normalized`:
  - `focus`
  - `goal`
  - `constraints[]`
  - `changes[]` (add/remove/reprioritize)
- `status`: committed | pending | rejected
- `conflicts[]`: 모순/불명확 사유
- `timestamp`

### 5.3 Guard 규칙(서버)
- 모순 검사: 예) `2주내 + 최고품질 + 인력1명` → pending + conflict
- 스코프 폭발: changes > 3 → pending(다음 라운드로 이월 제안)
- 라운드 적합성: R1에 구현 상세만 요구 → pending(“R2로 이동”)
- 금지 규칙: 프로젝트별 blacklist(예: 개인정보 저장 등) → rejected

### 5.4 프롬프트 주입 규칙(중요)
- **committed만** “Steering Block”에 반영
- pending/rejected는 `Open_Issues`로만 기록하고 에이전트에게 “질문으로 확인”을 유도

---

## 6) 에이전트 공통 Steering Block(최상단 강제)
모든 에이전트 시스템 프롬프트 최상단에 삽입:

[STEERING — MUST FOLLOW]
Focus: {{committed.focus}}
Goal: {{committed.goal}}
Constraints: {{committed.constraints}}
ApprovedChanges: {{committed.changes}}

RULES

Focus 범위를 벗어난 논점 확장 금지

Goal/Constraints를 최우선 반영

ApprovedChanges 외 신규 기능 제안 금지(특히 R2/R3)

불명확하면 Unknown 처리 + 확인 질문 1~2개만 제시

답변 끝에 'Steering Compliance Check: OK/NOT_OK' 포함

markdown
코드 복사

---

## 7) 역할별 출력 스키마(고정)
### 7.1 PRD Owner (R1)
- `Problem`
- `TargetUsers`
- `SuccessMetrics` (3개 이내)
- `MVP_InScope` / `MVP_OutOfScope`
- `UserScenarios` (2개)
- `OpenQuestions` (3개 이내)
- `SteeringComplianceCheck`

### 7.2 UX Lead
#### R1 UX 스키마
- `PrimaryUserFlow` (3~6 steps)
- `KeyScreens` (3 screens: 목적/구성요소/CTA/상태)
- `InteractionRules` (loading/empty/error/success)
- `DesignConstraints` (3~5개)
- `SteeringComplianceCheck`

#### R2 UX 스키마
- `UXRisksTop3`
- `DesignAlternatives` (A/B 2안: 장단점/비용)
- `DecisionAsks` (PM에게 결정 요청 2개)
- `SteeringComplianceCheck`

#### R3 UX 스키마
- `HandoffChecklist` (10개 이내)
- `AcceptanceCriteria` (5개 이내)
- `QAPlan` (간단)
- `SteeringComplianceCheck`

### 7.3 Tech Lead
#### R1 TECH 스키마
- `ArchitectureSketch`
- `APIsAndDataModel` (핵심만)
- `ImplementationSteps` (3~6)
- `TechRisksTop3`
- `SteeringComplianceCheck`

#### R2 TECH 스키마
- `RisksTop3` (R1과 중복 금지)
- `Mitigations`
- `FeasibilityCheck` (조건부)
- `DisproofQuestions` (2개)
- `SteeringComplianceCheck`

#### R3 TECH 스키마
- `BuildPlan` (구체 단계)
- `TestingPlan`
- `ReleasePlan`
- `KnownLimitations`
- `SteeringComplianceCheck`

### 7.4 Delivery Manager
#### R1 DM 스키마
- `PriorityDecision`
- `Milestones` (조건부)
- `ResourcingAssumptions`
- `DecisionLog` (1~3개)
- `SteeringComplianceCheck`

#### R2 DM 스키마
- `Tradeoffs` (무엇을 포기/유지)
- `Decision` (Go/Conditional/No-Go)
- `Conditions` (Conditional일 때)
- `DecisionLog`
- `SteeringComplianceCheck`

#### R3 DM 스키마
- `FinalScope`
- `Timeline`
- `Owners` (역할 매핑)
- `RisksAndMitigations`
- `SuccessMetrics`
- `DecisionLog`
- `SteeringComplianceCheck`

### 7.5 Verifier (R3 only)
- `GateStatus`: Go | Conditional | No-Go
- `SteeringCompliance`: OK | NOT_OK
- `RepeatedContentCheck`: OK | NOT_OK
- `MissingCriticalInfo`
- `NextAction` (END_GATE에서 사용자에게 제안)

---

## 8) 반복 방지(서버 가드)
1. **중복 출력 검사**: 이전 phase의 핵심 항목과 70% 이상 중복되면 1회 rewrite
2. **R2/R3 신규 MVP 제안 금지**: ApprovedChanges 외 기능 추가가 나오면 rewrite
3. **세션 락 + request_id 아이들포턴시**: 중복 실행 방지
4. **WAIT_USER / USER_GATE**에서 자동 진행 금지: 사용자 액션이 있어야만 다음 phase

---

## 9) 최종 리포트(/report) 스키마(권장 JSON)
- `ExecutiveSummary`
- `FinalScope`
- `Architecture`
- `UXSpecSummary`
- `TimelineAndOwners`
- `Risks`
- `DecisionLog`
- `OpenIssues` (pending 항목 포함)
- `NextExperiments`

---

## 10) 구현 체크리스트(DoD)
- [ ] 4역할 프롬프트와 출력 스키마가 고정되어 반복이 감소
- [ ] USER_GATE에서 최소 필수 입력만으로 진행 가능(Advanced 접힘)
- [ ] 매 턴 사용자 발화가 Steering Guard를 거쳐 committed만 주입됨
- [ ] 3라운드 종료 후 END_GATE에서 finalize/extend/new_session 선택 가능
- [ ] /report에 최종 결과가 JSON 기반으로 렌더링됨

---