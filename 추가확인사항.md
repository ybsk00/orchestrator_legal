# [PATCH] 법무 시뮬레이터 4인 구성 — Round1 Judge 선행 + USER_GATE 최소 필수 + 민사 No-Go 조기 종료 (v1.1)
목표: 기존 “법무 시뮬레이터(4인: Judge/Claimant/Opposing/Verifier)” 설계를 다음 3가지로 보완한다.
1) **Round1은 Judge가 먼저**(단, 판단 금지: 쟁점/누락사실/입증책임 프레임만)
2) **USER_GATE 입력폼 최소 필수 필드로 축소**(라운드별 2~3개만 강제, 나머지는 “고급 옵션”으로 접기)
3) **민사에서 Verifier R2가 No-Go면 Round3을 건너뛰고 END_GATE로 이동**(자동 종료가 아니라 “사용자 선택”으로 종료/보완/새세션 결정)

---

## 1) Round1 순서 수정: Judge 선행(프레임 고정)
### 1.1 Phase 순서(공통)
- `FACTS_INTAKE` → `FACTS_STIPULATE` → **`JUDGE_R1_FRAME`** → `CLAIMANT_R1` → `OPPOSING_R1` → `VERIFIER_R1` → `USER_GATE`

> NOTE: Round1 Judge는 “판단/승패예측” 금지. 오직 프레임(쟁점 후보/누락 사실 질문/입증책임)을 생성한다.

### 1.2 JUDGE_R1_FRAME 출력 스키마(고정, 3개만)
- `Issue_Candidates` (max 5)
- `Missing_Facts_Questions` (max 5)
- `Burden_Of_Proof_Map` (간단히: 요건사실/구성요건 단위)

금지:
- `DecisionRange`, `승패 가능성`, `결론`, `권고` 금지
- ConfirmedFacts 밖 사실 단정 금지

---

## 2) USER_GATE 최소 필수 입력폼(라운드별)
원칙: **필수는 2~3개만** 강제하고, 나머지는 “고급 옵션(Advanced)”으로 접는다.
- 프론트에서 `required_fields`만 검증(빈 값이면 진행 불가)
- Advanced는 사용자가 필요 시만 입력

### 2.1 Round1 USER_GATE (필수 2개)
필수:
1) `FocusIssue` (필수, 1개 선택) — Issue_Candidates 또는 open_issues에서 선택
2) `Goal` (필수, 1개 선택)
   - `win_rate`(승소가능성) / `risk_min`(리스크 최소) / `settlement`(조기종결/합의) / `evidence_first`(증거보강)
옵션(Advanced):
- `Stance` (강경/중립/유연)
- `FactCorrection` (사실 보완/정정, 300자)
- `Exclusions` (개인정보 노출 금지 등)

### 2.2 Round2 USER_GATE (필수 3개)
필수:
1) `ProofPriority` (필수, 1개)
   - `key_evidence` / `procedural_defense` / `damage_calc` / `testimony`
2) `EvidenceLevel` (필수, 1개)
   - `sufficient` / `partial` / `insufficient`
3) `Constraints` (필수, 1개 이상)
   - `deadline_2weeks` / `budget_limit` / `no_external_counsel` / `no_personal_data_exposure`
옵션(Advanced):
- `EvidenceToAcquire` (추가 확보 가능 증거 체크)
- (민사 + goal=settlement일 때) `SettlementRange` (양보선/조건)
- `UserNotes` (300자)

### 2.3 Round3 END_GATE (필수 2개)
필수:
1) `EndAction` (필수, 택1)
   - `finalize` / `extend_once` / `new_session`
2) `ReportStyle` (필수, 택1)
   - `risk`(리스크 중심) / `strategy`(전략 중심) / `settlement`(합의안 중심)
옵션(Advanced):
- `FinalNotes` (300자)

---

## 3) Steering Block 주입 규칙(변경 없음, 단 필수 필드 기반으로 구성)
- USER_GATE 제출값을 `legal_steering`으로 저장
- 다음 Phase 실행 시 모든 에이전트 시스템 프롬프트 최상단에 주입

### 3.1 Steering Block 템플릿(요약형, 최소 필드 중심)
[LEGAL STEERING — MUST FOLLOW]
FocusIssue: {{focus_issue}}
Goal: {{goal}}
Constraints: {{constraints}}
(Advanced) Stance: {{stance}}
(Advanced) Exclusions: {{exclusions}}
(Advanced) Notes: {{notes}}

RULES

FocusIssue 범위를 벗어난 논점 확장은 금지입니다.

Goal/Constraints를 최우선으로 반영하세요.

ConfirmedFacts 외 사실 단정 금지(Unknown 처리).

끝에 Steering Compliance Check: OK/NOT OK 포함.

yaml
코드 복사

---

## 4) 민사 No-Go 조기 종료 패치(Verifier R2 → END_GATE)
### 4.1 적용 범위
- `case_type == "civil"` 일 때만 적용(권장)
- `VERIFIER_R2`가 `GateStatus = "No-Go"`이면 Round3을 생략하고 `END_GATE`로 이동

### 4.2 No-Go 판정 기준(Verifier 룰에 추가)
다음 중 1개 이상이면 `No-Go` 가능:
- `MissingEvidence`에 “치명적 증거 부재”가 2개 이상
- Steering 모순: `deadline_2weeks` + `no_external_counsel` + `EvidenceLevel=insufficient` 등으로 “진행 불가”
- Goal=settlement인데 SettlementRange/조건이 전혀 없고, 합의안 산출이 불가능

### 4.3 동작(중요: 자동 종료 아님)
- No-Go 발생 시:
  - `phase = END_GATE`
  - END_GATE UI에서 사용자 선택:
    - `finalize`: 현재까지 요약 리포트 생성(“No-Go 사유 + 보완 체크리스트 + 대안 2개” 포함)
    - `input`: (권장) “증거/사실 보완 후 재개” 플로우로 라우팅(= USER_GATE로 되돌림)
    - `new_session`: 새 세션 생성
  - `extend_once`는 No-Go 상황에서는 숨기거나 비활성화(권장)

---

## 5) 상태머신 전이표 수정(state_machine.py)
### 5.1 신규/변경 Phase
- 신규: `JUDGE_R1_FRAME`
- 유지: `USER_GATE`, `END_GATE`, `FINALIZE_DONE`

### 5.2 전이(요약)
- `FACTS_STIPULATE` → `JUDGE_R1_FRAME`
- `JUDGE_R1_FRAME` → `CLAIMANT_R1`
- `VERIFIER_R1` → `USER_GATE`
- `VERIFIER_R2`:
  - if `case_type == civil` and `GateStatus == No-Go` → `END_GATE`
  - else → `USER_GATE`
- `VERIFIER_R3` → `END_GATE`

---

## 6) 프론트 패치(app/session/[id]/page.tsx)
### 6.1 Gate UI에서 필수 필드 검증
- Round별 `required_fields`만 검증:
  - R1: focus_issue, goal
  - R2: proof_priority, evidence_level, constraints(>=1)
  - R3: end_action, report_style

### 6.2 Advanced 폼은 접기(default collapsed)
- “고급 옵션” 토글로 펼치기
- 사용자는 입력 부담 없이 필수만으로 진행 가능

---

## 7) 완료 기준(DoD)
- [ ] Round1에서 Judge가 선행하며, 출력은 프레임 3개만 생성(판단 금지)
- [ ] USER_GATE 필수 필드가 라운드별 2~3개로 축소되었고 Advanced는 접힘
- [ ] 민사에서 VERIFIER_R2 No-Go 시 Round3 건너뛰고 END_GATE로 이동
- [ ] END_GATE에서 finalize/input/new_session 선택이 정상 동작
- [ ] Steering Block이 최소 필드 기반으로 주입되고 FocusIssue 이탈이 감소

---






