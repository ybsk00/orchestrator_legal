사용자 개입(Steering) 기능 구현 계획
목표
토론이 주제에서 벗어나는 것을 방지하기 위해 "사용자 방향 제어(Steering)" 메커니즘을 구현합니다.

상태 분리: WAIT_USER (대화 중), USER_GATE (라운드 종료 후), END_GATE (최종 종료)로 명확히 분리.
Steering: 사용자의 제약 조건이나 목표를 다음 라운드 에이전트 프롬프트 최상단에 강제 주입.
가드레일: Steering 위반 시 서버에서 자동 재작성(Rewrite) 수행.
사용자 검토 필요 사항
IMPORTANT

이 변경 사항은 라운드 자동 진행을 중단시킵니다. 사용자가 상호작용(또는 "건너뛰기" 클릭)을 해야만 다음 라운드로 진행됩니다.

변경 제안
1. 백엔드 상태 및 로직 (
backend/api/routes.py
, 
state_machine.py
)
Phase 열거형 확장: USER_GATE, END_GATE 추가.
execute_round
 수정:
진입 시점 고정:
Round 1: V_R1_AUDIT 완료 후 -> USER_GATE
Round 2: V_R2_GATE 완료 후 -> USER_GATE
Round 3: V_R3_SIGNOFF 완료 후 -> END_GATE
ROUND_END 이벤트 페이로드 확장: round_index, turn_index, 
phase
, decision_summary, what_changed, open_issues, verifier_gate_status.
엔드포인트 추가: POST /sessions/{session_id}/steering
Payload: action, steering (옵션), request_id (Idempotency 보장).
비동기 처리 (Race Condition 방지):
요청 시 상태만 업데이트하고 START_ROUND 이벤트 발행.
실제 라운드 실행은 turn_manager 큐 또는 백그라운드 작업에서 처리.
Action 처리:
skip / 
input
: system_event=SKIP으로 처리하여 라운드 증가 로직 일원화.
finalize
: FINALIZE_DONE으로 이동.
extend: extend_count 증가 (최대 1회). allowed_rounds = BASE_MAX_ROUNDS + extend_count 로직으로 판정.
new_session: 결론 고정 후 새 세션 생성.
2. Steering 및 가드레일 (backend/agents/)
Steering 데이터 모델: 세션/CaseFile에 steering 정보 저장.
프롬프트 주입:
모든 에이전트(특히 Agent 2)의 시스템 프롬프트 최상단에 Steering Block 삽입.
Agent 2부터 라운드가 시작되도록 고정.
Compliance Check 강제: 응답 끝에 Steering Compliance Check: OK/NOT OK 출력 필수화.
준수 검증 (가드레일):
패턴 매칭: EXCLUSION_PATTERNS, CONSTRAINT_RULES 테이블을 통한 정교한 검사 (단순 키워드 X).
재작성 로직:
"NOT OK" 출력 시 또는 패턴 위반 감지 시 서버에서 1회 자동 재작성 요청.
위반 사유 로그 기록.
3. 프론트엔드 (app/session/[id]/page.tsx)
상태 처리: USER_GATE, END_GATE 상태에 따른 UI 분기.
GateSummaryCard: ROUND_END 이벤트 페이로드를 사용하여 즉시 렌더링.
SteeringPanel: "방향/조건 추가" 클릭 시 표시.
EndGateCard: 라운드 3 종료 시 표시 (Finalize, Extend, New Session).
검증 계획
수동 검증 시나리오
상태 전환: Verifier 단계 종료 후 USER_GATE 진입 확인.
Steering 주입: 제약 조건 입력 후 다음 라운드 Agent 2가 Steering Compliance Check: OK를 출력하는지 확인.
가드레일 동작: 금지어 변형 표현(예: "콜드메일") 입력 시 재작성 로직 동작 확인.
확장 기능: extend 시 라운드 4 진행 확인. skip 시 레이스 컨디션 없이 안정적 진행 확인.