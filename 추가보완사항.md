# 법무 시뮬레이터(모의 재판) — 4인 구성(피고 제외) 보완 구현안 (AntiGravity용 v1.0)
목표: 기존 오케스트레이터를 복사해 “법무 시뮬레이션”으로 전환하되, **피고(당사자) 에이전트는 제외**하고 4인 구조로 MVP를 안정적으로 구현한다.  
핵심: 피고 역할을 제거하는 대신, **Facts Stipulation + 라운드별 법무 입력폼(USER_GATE)** 으로 “당사자 진술/사실관계”를 시스템이 강제 수집하여 재판이 산으로 가지 않게 한다.

---

## 1) 최종 역할 구성(4인) — 사건 유형별 자동 매핑
### 1.1 공통 4개 역할
- **Judge(재판장)**: 절차 통제, 쟁점 확정, 판단/권고
- **Claimant(주장측)**: 형사=Prosecutor(검사) / 민사=Plaintiff Counsel(원고 대리인)
- **Opposing(상대측)**: 형사=Defense Counsel(변호인) / 민사=Defendant Counsel(피고 대리인)
- **Verifier(검증관)**: 절차/근거/Steering 준수/환각 방지 게이트 판정

> NOTE: “피고(당사자)”는 별도 에이전트로 두지 않는다.  
> 대신 **사용자 입력(진술/증거)을 Facts 단계와 라운드별 USER_GATE에서 강제**한다.

---

## 2) 피고 제거로 생기는 공백을 메우는 2가지 장치(필수)
### 2.1 Facts Stipulation 강화(필수)
피고 역할이 사라지면 “사실관계(진술)”가 약해진다. 따라서 Round 시작 전 Facts 단계를 강하게 만든다.

- **FACTS_INTAKE**: 사용자에게 사건 개요/행위/시간/증거/상대 주장 입력 받기
- **FACTS_STIPULATE**: 시스템이 아래 3분류로 정리(스키마 고정)
  - `ConfirmedFacts` (증거 또는 당사자 합의로 확정)
  - `DisputedFacts` (다툼/쟁점 사실)
  - `MissingFactsQuestions` (판단에 필요한 누락 질문)

#### Facts 게이트(중요)
- `MissingFactsQuestions`가 **3개 이상**이면 자동으로 **USER_GATE_REQUIRED(사실 보완)** 로 전환
- 사용자는 다음 중 선택:
  1) **추가 사실 입력 후 진행**
  2) **불명확으로 진행(리스크 감수)**

> 이렇게 해야 “피고 진술” 부재로 인한 환각/가정 쌓기가 줄어든다.

### 2.2 라운드별 USER_GATE 입력폼(필수)
각 라운드 종료 시 사용자에게 **법무용 정형 입력**을 받는다(자유발화는 옵션).

- Round1 USER_GATE: “쟁점 확정 + 목표/포지션”
- Round2 USER_GATE: “입증/반증 방향 + 증거 확보 계획 + 양보선(민사)”
- Round3 END_GATE: “최종 리포트 톤/형태 + 종료/연장/새 세션”

(상세 필드 정의는 6절 참고)

---

## 3) 상태머신(Phase) — 4인 구조 기준
### 3.1 공통 Phase(권장)
- `FACTS_INTAKE` → `FACTS_STIPULATE` → `JUDGE_R1` → `CLAIMANT_R1` → `OPPOSING_R1` → `VERIFIER_R1` → `USER_GATE`
- `OPPOSING_R2` → `CLAIMANT_R2` → `JUDGE_R2` → `VERIFIER_R2` → `USER_GATE`
- `OPPOSING_R3` → `CLAIMANT_R3` → `JUDGE_R3` → `VERIFIER_R3` → `END_GATE`
- `FINALIZE_DONE`

> NOTE: Round2/3는 **OPPOSING부터 시작**한다.  
> 이유: 사용자가 입력한 Steering(목표/제약)을 기준으로 “상대측이 어떤 반박/리스크를 제기할지”를 먼저 내면, 이후 Judge 정리가 훨씬 안정적이다.

### 3.2 민사 조기 종료 옵션
- `VERIFIER_R2`에서 `Gate_Status = No-Go` 이면
  - Round3 건너뛰고 `END_GATE`로 이동
  - 최종 리포트에는 “No-Go 사유 + 대안 2개” 포함

---

## 4) 프롬프트 교체 지시(핵심: 역할별 스키마 고정)
### 4.1 Steering Block(최상단 강제 주입)
모든 에이전트 시스템 프롬프트 최상단에 아래 블록을 삽입한다.

[LEGAL STEERING — MUST FOLLOW]
CaseType: {{case_type}} / Jurisdiction: {{jurisdiction}}
FocusIssues: {{focus_issues}}
Goal: {{goal}}
Stance: {{stance}}
Constraints: {{constraints}}
Exclusions: {{exclusions}}
UserNotes: {{note}}

RULES

FocusIssues 범위를 벗어나 논점을 확장하지 마세요.

Goal/Stance/Constraints를 최우선으로 반영하세요.

Exclusions 위반(개인정보/공격적 표현/외부자문 등)은 금지입니다.

ConfirmedFacts 외 임의 사실 생성 금지(Unknown 처리).

끝에 Steering Compliance Check: OK/NOT OK 포함.

autohotkey
코드 복사

### 4.2 Judge(재판장) — 출력 스키마(고정)
- `Issues`
- `Findings` (ConfirmedFacts 기반)
- `BurdenOfProof`
- `DecisionRange` (조건부/범위 표현)
- `RecommendedNextSteps` (사내 액션)
- `Citations` (증거ID/사내규정/조항. 없으면 “No citation”)

금지:
- 확정적 법률 자문(“무조건 승소” 등)
- 없는 조문/판례 생성

### 4.3 Claimant(검사/원고대리) — 출력 스키마(고정)
- `Claims`
- `LegalElements` (요건/구성요건)
- `EvidencePlan` (증거ID 기반)
- `WeakPoints` (자기 약점 1~2개)

### 4.4 Opposing(변호인/피고대리) — 출력 스키마(고정)
- `CounterArguments`
- `DisproofPlan`
- `ProceduralRisks`
- `SettlementOptions` (민사일 때만, 2~3안)

### 4.5 Verifier(검증관) — 출력 스키마(고정)
- `GateStatus`: `Go | Conditional | No-Go`
- `SteeringCompliance`: `OK | NOT_OK`
- `UnsupportedClaims` (근거 없는 주장 리스트)
- `MissingEvidence` (필요 증거/질문)
- `NextRoundFocus` (USER_GATE에서 사용자에게 물을 포인트)

---

## 5) 가드레일(Rewrite) — 피고 제외 환경에서 강화(권장)
### 5.1 임의 사실 생성 방지
- 에이전트 답변에서 ConfirmedFacts에 없는 사실 단정 표현 감지 시 → Rewrite 1회
- Rewrite 프롬프트: “Unknown 처리하고 질문으로 바꿔라”

### 5.2 확정적 자문 방지
- “반드시/확실히/100%/무조건 승소” 등 감지 시 → Rewrite 1회

### 5.3 Steering 이탈 방지
- FocusIssues 밖 확장 → Rewrite 1회
- Exclusions 위반(개인정보/공격적 표현) → Rewrite 1회

---

## 6) 라운드별 USER_GATE 입력폼(법무용) — 피고 역할 대체 장치
### 6.1 Round1 USER_GATE(필수)
- `핵심 쟁점 선택` (필수, 최대 2)
- `목표(Goal)` (필수, 1개)
  - 승소가능성 / 리스크최소 / 조기종결(합의/조정) / 증거보강
- `포지션(주장 강도)` (필수)
  - 강경 / 중립 / 유연(협상)
- `사실 보완/정정` (옵션, 300자)

### 6.2 Round2 USER_GATE(필수)
- `입증 우선순위` (필수, 1개)
- `보유 증거 수준` (필수)
- `추가로 확보 가능한 증거` (필수, 복수)
- (민사일 때) `합의 관심 여부` + `양보 가능 범위` (조건부 필수)
- `제약 조건` (필수, 복수)
  - 2주 내 결론 / 예산 상한 / 외부 자문 불가 등
- `추가 지시` (옵션, 300자)

### 6.3 Round3 END_GATE(필수)
- `결론 처리` (필수)
  - 최종 리포트 생성 / 1라운드 연장(+1) / 새 세션
- `리포트 형태` (필수)
  - 리스크 중심 / 전략 중심 / 합의안 중심
- `최종 지시사항` (옵션)

---

## 7) 구현 파일 작업 지시(요약)
- [MODIFY] `backend/models/session.py`
  - case_type, jurisdiction, facts_stipulated, steering(legal_steering) 저장
- [MODIFY] `backend/api/routes.py`
  - session 생성 시 case_type 받기
  - `POST /sessions/{id}/steering` 처리(라운드별 필수 필드 검증)
- [MODIFY] `backend/orchestrator/state_machine.py`
  - FACTS_* / JUDGE_R* / CLAIMANT_R* / OPPOSING_R* / VERIFIER_R* / USER_GATE / END_GATE 전이표 반영
- [MODIFY] `backend/agents/*`
  - 4인 역할 프롬프트/스키마 고정(상단 Steering Block 포함)
- [MODIFY] `app/session/[id]/page.tsx`
  - USER_GATE/END_GATE에서 라운드별 법무 폼 렌더링 및 제출 강제

---

## 8) 완료 기준(DoD)
- [ ] 피고 에이전트 없이 4인(Judge/Claimant/Opposing/Verifier)로 라운드가 정상 진행된다
- [ ] FACTS_STIPULATE에서 누락 사실이 많으면 USER_GATE로 사실 보완을 강제한다
- [ ] 매 라운드 USER_GATE 입력이 Steering으로 저장되고 다음 라운드 프롬프트 최상단에 주입된다
- [ ] ConfirmedFacts 밖 임의 사실 단정/확정적 자문/Steering 이탈은 Rewrite 1회로 교정된다
- [ ] Round3 END_GATE에서 종료/연장/새세션이 정상 동작하고 /report가 생성된다

---






