1) 가장 중요한 누락: “Steering Guard”가 설계/파일 단위로 빠져 있습니다

계획에 “Steering Guard 포함”이라고만 되어 있고, 정규화/검증/커밋/주입의 단일 소스가 없습니다.

반드시 추가해야 할 것

backend/orchestrator/steering/

normalizer.py : 사용자 입력 → {focus, goal, constraints, changes} 구조화

guard.py : 모순/스코프폭발/라운드부적합/금지규칙 검사 → committed/pending/rejected

committer.py : committed만 세션/CaseFile에 저장하고 “주입용 SteeringBlock” 생성

주입 원칙 고정: “원문 전체 주입 금지”, committed만 5~7줄로 상단 주입

이게 없으면 “매 턴 사용자 의견 반영”이 곧바로 프롬프트 오염/모순 누적로 이어져서 토론이 산으로 갑니다.

2) 상태머신은 ‘프로젝트 타입별 전이표 분리’가 필수입니다

현재 설계는 DEV_PROJECT_PHASE_TRANSITIONS를 추가한다고 했는데, 실제로는 아래가 필요합니다.

보완 포인트

state_machine.py는 순수 함수 + 전이표만 들고 있어야 합니다.

project_type별로 전이표를 완전히 분리:

GENERAL_TRANSITIONS

LEGAL_TRANSITIONS

DEV_PROJECT_TRANSITIONS

get_next_phase(session)에서 project_type에 따라 전이표를 선택하도록 단일화

이렇게 해야 기존 일반/법무 모드에 영향 없이 확장 가능합니다.

3) 라운드 증가/게이트 규칙을 “단일 소스”로 고정해야 합니다

Dev 프로젝트도 USER_GATE/END_GATE가 들어가므로, 과거에 지적하셨던 것처럼 라운드 증가 시점이 애매하면 루프가 납니다.

권장 규칙(정석)

라운드 증가: USER_GATE에서 사용자가 action(skip/input)을 보낼 때만 current_round += 1

서버는 USER_GATE/END_GATE 상태에서 자동 진행 금지

current_round와 phase만 참조(다른 곳에서 라운드 계산 금지)

4) “에이전트 출력 스키마 고정”이 계획안에 빠져 있습니다

역할만 나누면 반복은 줄어들지만, 구조화 출력 스키마를 고정하지 않으면 다시 장문 반복/재진술이 발생합니다.

보완 권장

DevProject 에이전트별로 라운드별 스키마를 고정하세요(텍스트든 JSON이든).

PRD_R1: Problem / In-Out / Metrics / OpenQuestions

UX_R1: Flow / KeyScreens(3) / States

TECH_R1: Architecture / APIs&DataModel / RisksTop3

DM_R1: Milestones / Tradeoffs / DecisionLog
…R2/R3도 동일한 방식으로 “필수 섹션”을 강제

그리고 중복 감지/재작성(Rewrite 1회) 가드도 함께 넣으셔야 합니다.

이전 라운드 대비 Top 항목 70% 이상 중복 시 1회 재작성

5) Verifier는 “R3만” 두는 게 MVP에 유리하나, Gate 페이로드는 반드시 넣어야 합니다

R3에만 Verifier를 두는 건 속도/길이/반복 측면에서 올바른 선택입니다.
다만 R1/R2의 USER_GATE에서 사용자가 판단할 수 있도록 라운드 종료 이벤트에 요약 페이로드가 필요합니다.

권장 ROUND_END 페이로드

decision_summary

what_changed

open_issues

next_round_focus_suggestion (UX/Tech/PRD 관점 1줄씩)

이게 없으면 USER_GATE가 “무엇을 입력해야 할지” 애매해져서 사용자 개입 품질이 떨어집니다.

6) 동시성/아이들포턴시(중복 턴 실행 방지)도 Dev 모드에 동일 적용해야 합니다

계획안에 Dev에 대한 락/아이들포턴시가 명시되지 않았습니다. (법무에서 이미 필요하다고 결론 내리셨던 부분)

최소 보완

세션 단위 asyncio.Lock

request_id 기반 idempotency 캐시

SSE 재연결 시 event_id/Last-Event-ID (최소: 턴 종료 이벤트 재전송 가능)

이게 없으면 “버튼 연타/재연결”에서 동일 턴이 중복 실행됩니다.

7) 파일 구조는 devproject 폴더로 분리하는 게 맞고, 네이밍만 통일하면 됩니다

현재:

backend/agents/devproject/ (좋음)

backend/prompts/devproject/ (좋음)

보완:

기존 agents 네이밍이 devproject_*.py 형태라면 폴더 방식과 충돌하니 둘 중 하나로 통일

권장: backend/agents/devproject/agent_prd_owner.py 같은 형태